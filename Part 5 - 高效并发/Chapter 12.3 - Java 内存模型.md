# Chapter 12.3 - Java å†…å­˜æ¨¡åž‹

Created by : Mr Dk.

2020 / 02 / 03 16:53

Ningbo, Zhejiang, China

---

## 12.1 æ¦‚è¿°

å¹¶å‘å¤„ç†æ˜¯ [*Amdahl å®šå¾‹*](https://en.wikipedia.org/wiki/Amdahl%27s_law) ä»£æ›¿ *æ‘©å°”å®šå¾‹* æˆä¸ºè®¡ç®—æœºæ€§èƒ½å‘å±•æºåŠ¨åŠ›çš„æ ¹æœ¬åŽŸå› ã€‚è®¡ç®—æœºçš„è¿ç®—é€Ÿåº¦ä¸Žå…¶å­˜å‚¨å’Œé€šä¿¡å­ç³»ç»Ÿçš„é€Ÿåº¦å·®è·å¤ªå¤§ï¼Œéœ€è¦ä½¿ç”¨ä¸€äº›æ‰‹æ®µå°† CPU çš„è¿ç®—èƒ½åŠ›åŽ‹æ¦¨å‡ºæ¥ã€‚

## 12.2 ç¡¬ä»¶çš„æ•ˆçŽ‡ä¸Žä¸€è‡´æ€§

çŽ°ä»£è®¡ç®—æœºç³»ç»ŸåŠ å…¥ä¸€å±‚æˆ–å¤šå±‚è¯»å†™é€Ÿåº¦å°½å¯èƒ½æŽ¥è¿‘ CPU çš„ cache ä½œä¸ºå†…å­˜ä¸Ž CPU ä¹‹é—´çš„ç¼“å†²ï¼Œå¼•å…¥äº†æ–°çš„é—®é¢˜ï¼šç¼“å­˜ä¸€è‡´æ€§ (Cache Coherence)ï¼šåœ¨å¤šè·¯ CPU ä¸­ï¼Œæ¯ä¸ª CPU æœ‰è‡ªå·±çš„ cacheï¼Œè€Œå®ƒä»¬åˆå…±äº«åŒä¸€ä¸»å†…å­˜ (Main Memory)ï¼Œè¿™ç±»ç³»ç»Ÿè¢«ç§°ä¸º **å…±äº«å†…å­˜å¤šæ ¸ç³»ç»Ÿ** (Shared Memory Multiprocessors System)ã€‚å½“å¤šä¸ª CPU çš„è¿ç®—ä»»åŠ¡æ¶‰åŠåŒä¸€å—ä¸»å­˜åŒºåŸŸæ—¶ï¼Œå„ CPU è®¿é—® cache æ—¶éœ€è¦éµå¾ªä¸€å®šçš„åè®®ã€‚

æ­¤å¤–ï¼ŒCPU å¯èƒ½å¯¹è¾“å…¥ä»£ç è¿›è¡Œ **ä¹±åºæ‰§è¡Œ** (Out-Of-Order Execution)ã€‚CPU ä¼šåœ¨è®¡ç®—ä¹‹åŽå°†ä¹±åºæ‰§è¡Œçš„ç»“æžœé‡ç»„ï¼Œä¿è¯è¯¥ç»“æžœä¸Žé¡ºåºæ‰§è¡Œçš„ç»“æžœä¸€è‡´ï¼Œä½†å¹¶ä¸ä¿è¯ç¨‹åºä¸­å„ä¸ªè¯­å¥è®¡ç®—çš„å…ˆåŽé¡ºåºä¸Žè¾“å…¥ä»£ç ä¸­çš„é¡ºåºä¸€è‡´ã€‚JVM çš„ JIT ç¼–è¯‘å™¨ä¸­ä¹Ÿæœ‰æŒ‡ä»¤é‡æŽ’åºä¼˜åŒ–ã€‚

## 12.3 Java å†…å­˜æ¨¡åž‹

JVM è§„èŒƒè¯•å›¾å®šä¹‰ä¸€ç§ **Java å†…å­˜æ¨¡åž‹** (Java Memory Model, JMM)ï¼Œä»¥å±è”½å„ç§ç¡¬ä»¶å’Œ OS çš„å†…å­˜è®¿é—®å·®å¼‚ï¼Œå®žçŽ°è®© Java ç¨‹åºåœ¨å„å¹³å°ä¸‹éƒ½èƒ½è¾¾åˆ°ä¸€è‡´çš„è®¿å­˜æ•ˆæžœã€‚è€Œä¸åƒ C/C++ ç›´æŽ¥ä½¿ç”¨ç‰©ç†ç¡¬ä»¶å’Œ OS çš„å†…å­˜æ¨¡åž‹ã€‚

* JMM å¿…é¡»å®šä¹‰å¾—è¶³å¤Ÿä¸¥è°¨ï¼Œè®©å¹¶å‘è®¿é—®æ“ä½œä¸ä¼šäº§ç”Ÿæ­§ä¹‰
* JMM ä¹Ÿå¿…é¡»å®šä¹‰å¾—è¶³å¤Ÿå®½æ¾ï¼Œä½¿ JVM å®žçŽ°èƒ½å¤Ÿè‡ªç”±åˆ©ç”¨ç¡¬ä»¶æˆ– OS çš„ç‰¹æ€§æ¥èŽ·å¾—æ›´å¥½çš„æ‰§è¡Œé€Ÿåº¦

### 12.3.1 ä¸»å†…å­˜ä¸Žå·¥ä½œå†…å­˜

JMM çš„ä¸»è¦ç›®çš„æ˜¯å®šä¹‰ç¨‹åºä¸­å„ç§å˜é‡çš„è®¿é—®è§„åˆ™ï¼Œå³å…³æ³¨ JVM æŠŠå˜é‡å­˜å‚¨åˆ°å†…å­˜å’Œä»Žå†…å­˜ä¸­å–å‡ºè¿™æ ·çš„åº•å±‚ç»†èŠ‚ã€‚

* å®žä¾‹å­—æ®µ
* é™æ€å­—æ®µ
* æž„æˆæ•°ç»„å¯¹è±¡çš„å…ƒç´ 

ä¸åŒ…æ‹¬å±€éƒ¨å˜é‡å’Œå‡½æ•°å‚æ•°ï¼Œå› ä¸ºè¿™æ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œä¸ä¼šè¢«å…±äº«ï¼š

* å±€éƒ¨å˜é‡æ˜¯ reference ç±»åž‹æœ¬èº«ä½äºŽ Java æ ˆçš„å±€éƒ¨å˜é‡è¡¨ä¸­
* å¼•ç”¨çš„å¯¹è±¡ä½äºŽ Java Heapï¼Œå¯è¢«å„ä¸ªçº¿ç¨‹å…±äº«

JMM è§„å®šï¼Œæ‰€æœ‰çš„å˜é‡éƒ½å­˜å‚¨åœ¨ **ä¸»å†…å­˜** (Main Memory) ä¸­ï¼Œæ¯æ¡çº¿ç¨‹æœ‰è‡ªå·±çš„ **å·¥ä½œå†…å­˜** (Working Memory)ï¼š

* å·¥ä½œå†…å­˜ä¸­ä¿å­˜äº†è¯¥çº¿ç¨‹ä½¿ç”¨çš„å˜é‡çš„ä¸»å†…å­˜å‰¯æœ¬
* çº¿ç¨‹å¯¹å˜é‡çš„è¯»å†™éƒ½å¿…é¡»åœ¨ **å·¥ä½œå†…å­˜** ä¸­è¿›è¡Œ
* ä¸åŒçº¿ç¨‹ä¹‹é—´æ— æ³•ç›´æŽ¥è®¿é—®å¯¹æ–¹å·¥ä½œå†…å­˜ä¸­çš„å˜é‡ï¼Œéœ€è¦é€šè¿‡ä¸»å†…å­˜ä¼ é€’

JVM å¯èƒ½ä¼šè®©å·¥ä½œå†…å­˜ä¼˜å…ˆå­˜å‚¨äºŽå¯„å­˜å™¨å’Œ cache ä¸­ã€‚

### 12.3.2 å†…å­˜é—´äº¤äº’æ“ä½œ

å¯¹äºŽä¸»å†…å­˜ä¸Žå·¥ä½œå†…å­˜çš„äº¤äº’åè®®ã€‚JMM å®šä¹‰äº† 8 ç§æ“ä½œï¼ŒJVM çš„å®žçŽ°å¿…é¡»ä¿è¯æ¯ä¸€ç§æ“ä½œéƒ½æ˜¯åŽŸå­çš„ã€ä¸å¯å†åˆ†çš„ï¼š

* `lock` - å°†ä¸»å†…å­˜ä¸­çš„å˜é‡æ ‡è¯†ä¸ºæŸä¸ªçº¿ç¨‹ç‹¬å 
* `unlock` - å°†ä¸»å†…å­˜ä¸­çš„å˜é‡é‡Šæ”¾é”å®š
* `read` - å°†ä¸»å†…å­˜ä¸­çš„å˜é‡å€¼ä¼ è¾“åˆ°çº¿ç¨‹å·¥ä½œå†…å­˜ä¸­
* `load` - æŠŠä»Žä¸»å†…å­˜ä¸­å¾—åˆ°çš„å˜é‡å€¼æ”¾å…¥å·¥ä½œå†…å­˜çš„å‰¯æœ¬ä¸­
* `use` - æŠŠå·¥ä½œå†…å­˜ä¸­çš„å˜é‡å€¼è½¬é€’ç»™æ‰§è¡Œå¼•æ“Ž
* `assign` - æŠŠä»Žæ‰§è¡Œå¼•æ“Žä¸­æŽ¥æ”¶çš„å€¼èµ‹å€¼ç»™å·¥ä½œå†…å­˜å˜é‡
* `store` - æŠŠå·¥ä½œå†…å­˜ä¸­çš„å˜é‡ä¼ é€åˆ°ä¸»å†…å­˜ä¸­
* `write` - æŠŠä»Žå·¥ä½œå†…å­˜ä¸­å¾—åˆ°çš„å˜é‡æ”¾å…¥ä¸»å†…å­˜çš„å˜é‡ä¸­

ä¸»å†…å­˜ â‡” å·¥ä½œå…§å­˜ â‡” æ‰§è¡Œå¼•æ“Ž

* è¦æŠŠä¸€ä¸ªå˜é‡ä»Žä¸»å†…å­˜æ‹·è´åˆ°å·¥ä½œå†…å­˜ï¼Œå°±è¦æŒ‰é¡ºåºæ‰§è¡Œ `read` å’Œ `load`
* è¦æŠŠä¸€ä¸ªå˜é‡ä»Žå·¥ä½œå†…å­˜åŒæ­¥å›žä¸»å†…å­˜ï¼Œå°±è¦æŒ‰é¡ºåºæ‰§è¡Œ `store` å’Œ `write`
* åªè¦æ±‚æŒ‰é¡ºåºæ‰§è¡Œï¼Œä¸è¦æ±‚è¿žç»­æ‰§è¡Œ

JMM è§„å®šäº†æ‰§è¡Œä»¥ä¸ŠåŸºæœ¬æ“ä½œæ—¶å¿…é¡»æ»¡è¶³çš„è§„åˆ™ï¼š

* `read` + `load` å’Œ `store` + `write` å¿…é¡»æˆå¯¹å‡ºçŽ° - ä¸»å†…å­˜ â‡” å·¥ä½œå†…å­˜
* ä¸å…è®¸çº¿ç¨‹ä¸¢å¼ƒæœ€è¿‘çš„ `assign` æ“ä½œï¼Œå˜é‡åœ¨å·¥ä½œå†…å­˜ä¸­æ”¹å˜åŽå¿…é¡»åŒæ­¥å›žä¸»å†…å­˜
* ä¸å…è®¸çº¿ç¨‹æ— åŽŸå› åœ° (æ²¡æœ‰å‘ç”Ÿ `assign`) æŠŠå·¥ä½œå†…å­˜åŒæ­¥åˆ°ä¸»å†…å­˜
* æ–°çš„å˜é‡åªèƒ½åœ¨ä¸»å†…å­˜ä¸­è¯žç”Ÿ
* ä¸€ä¸ªå˜é‡åœ¨åŒä¸€æ—¶åˆ»åªå…è®¸è¢«ä¸€ä¸ªçº¿ç¨‹ `lock`ï¼Œä½† `lock` å¯ä»¥è¢«åŒä¸€æ¡çº¿ç¨‹é‡å¤æ‰§è¡Œå¤šæ¬¡ï¼Œå¹¶éœ€è¦ç›¸åŒæ¬¡æ•°çš„ `unlock`
* å¦‚æžœå¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œ `lock`ï¼Œåˆ™æ¸…ç©ºå·¥ä½œå†…å­˜ä¸­è¯¥å˜é‡çš„å€¼
* å¦‚æžœä¸€ä¸ªå˜é‡æ²¡æœ‰è¢« `lock`ï¼Œåˆ™ä¸å…è®¸ `unlock`ï¼›ä¸å…è®¸ `unlock` ä¸€ä¸ªè¢«å…¶å®ƒçº¿ç¨‹é”å®šçš„å˜é‡
* å¯¹ä¸€ä¸ªå˜é‡ `unlock` ä¹‹å‰ï¼Œå¿…é¡»å…ˆå°†å…¶åŒæ­¥å›žä¸»å†…å­˜ä¸­

### 12.3.3 å¯¹äºŽ volatile åž‹å˜é‡çš„ç‰¹æ®Šè§„åˆ™

å…³é”®å­— `volatile` æ˜¯ JVM æä¾›çš„æœ€è½»é‡çº§çš„åŒæ­¥æœºåˆ¶ï¼Œå½“ä¸€ä¸ªå˜é‡è¢«å®šä¹‰ä¸º `volatile` åŽï¼Œå°†å…·å¤‡ä¸¤ä¸ªè¯­ä¹‰ï¼š

1. ä¿è¯æ­¤å˜é‡å¯¹æ‰€æœ‰çº¿ç¨‹çš„å¯è§æ€§
2. ç¦æ­¢æŒ‡ä»¤é‡æŽ’åºä¼˜åŒ–

å¯è§æ€§ï¼šå½“ä¸€æ¡çº¿ç¨‹ä¿®æ”¹äº†å˜é‡å€¼ï¼Œæ–°å€¼å¯¹å…¶å®ƒçº¿ç¨‹æ¥è¯´å¯ä»¥ç«‹åˆ»å¾—çŸ¥ã€‚æ™®é€šå˜é‡ä¸èƒ½å®Œæˆå¯è§æ€§ï¼Œå€¼åœ¨çº¿ç¨‹é—´ä¼ é€’æ—¶éœ€è¦é€šè¿‡ä¸»å†…å­˜å®Œæˆã€‚ä»Žç‰©ç†å­˜å‚¨è§’åº¦ï¼Œå„çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ `volatile` å˜é‡ä¹Ÿå¯ä»¥å­˜åœ¨ä¸ä¸€è‡´çš„æƒ…å†µï¼Œä½†ç”±äºŽæ¯ä¸ªçº¿ç¨‹åœ¨ä½¿ç”¨ä¹‹å‰éƒ½è¦åˆ·æ–°è¯¥å€¼ï¼Œæ‰§è¡Œå¼•æ“Žçœ‹ä¸åˆ°è¿™ç§ä¸ä¸€è‡´çš„æƒ…å†µã€‚

ç”±äºŽ `volatile` å˜é‡çš„è¿ç®—åœ¨å¹¶å‘æ—¶ä¸æ˜¯åŽŸå­æ“ä½œï¼Œå› æ­¤åŒæ ·æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ã€‚åœ¨ä¸ç¬¦åˆä»¥ä¸‹ä¸¤æ¡è§„åˆ™çš„è¿ç®—åœºæ™¯ä¸­ï¼Œä»ç„¶éœ€è¦é€šè¿‡åŠ é”æ¥ä¿è¯åŽŸå­æ€§ï¼š

1. è¿ç®—ç»“æžœä¸ä¾èµ–å½“å‰çš„å˜é‡å€¼ï¼Œæˆ–ç¡®ä¿åªæœ‰å•ä¸€çº¿ç¨‹ä¿®æ”¹å˜é‡å€¼
2. å˜é‡ä¸éœ€è¦å…¶å®ƒçš„çŠ¶æ€å˜é‡å…±åŒå‚ä¸Žä¸å˜çº¦æŸ

> ä»€ä¹ˆçŽ©æ„å„¿...è¿™ä¹ˆæŠ½è±¡ ðŸ˜ª

æŒ‡ä»¤é‡æŽ’åºåŽï¼š

* æ™®é€šå˜é‡ä»…ä¼šä¿è¯å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰€æœ‰ä¾èµ–èµ‹å€¼ç»“æžœçš„åœ°æ–¹éƒ½èƒ½èŽ·å–æ­£ç¡®çš„ç»“æžœ
* ä¸èƒ½ä¿è¯å˜é‡èµ‹å€¼ä¸Žç¨‹åºä»£ç ä¸­çš„æ‰§è¡Œé¡ºåºä¸€è‡´

CPU å…è®¸å¤šæ¡æŒ‡ä»¤ä¸æŒ‰ç¨‹åºè§„å®šçš„é¡ºåºåˆ†å‘ç»™å„ä¸ªç”µè·¯å•å…ƒè¿›è¡Œå¤„ç†ï¼Œä¸”å¿…é¡»ä¿è¯ç¨‹åºèƒ½å¤Ÿå¾—å‡ºæ­£ç¡®çš„ç»“æžœã€‚æŒ‡ä»¤é‡æŽ’åºæ— æ³•è¶Šè¿‡å†…å­˜å±éšœã€‚ç»¼ä¸Šï¼Œ`volatile` çš„è¯»æ€§èƒ½ä¸Žæ™®é€šå˜é‡åŸºæœ¬æ²¡æœ‰åŒºåˆ«ï¼›å†™æ“ä½œä¸Šå¯èƒ½ä¼šæ…¢ä¸€äº›ï¼Œå› ä¸ºæ’å…¥äº†å¾ˆå¤šå†…å­˜å±éšœã€‚JMM å¯¹ `volatile` å˜é‡å®šä¹‰çš„è§„åˆ™ï¼š

* åœ¨å·¥ä½œå†…å­˜ä¸­ï¼Œæ¯æ¬¡ä½¿ç”¨å˜é‡å‰éœ€è¦ä»Žä¸»å†…å­˜ä¸­åˆ·æ–°æœ€æ–°çš„å€¼ï¼Œä¿è¯èƒ½å¤Ÿçœ‹è§å…¶å®ƒçº¿ç¨‹å¯¹å˜é‡çš„ä¿®æ”¹
* æ¯æ¬¡ä¿®æ”¹å˜é‡åŽå¿…é¡»ç«‹åˆ»åŒæ­¥å›žä¸»å†…å­˜ä¸­
* ä¸ä¼šè¢«æŒ‡ä»¤é‡æŽ’åºä¼˜åŒ–

### 12.3.4 é’ˆå¯¹ long å’Œ double åž‹å˜é‡çš„ç‰¹æ®Šè§„åˆ™

JMM å¯¹äºŽ 64-bit çš„æ•°æ®ç±»åž‹çš„è§„å®šè¾ƒä¸ºå®½æ¾ï¼Œå…è®¸éž `volatile` çš„å˜é‡æ‹†åˆ†ä¸ºä¸¤æ¬¡ 32-bit çš„æ“ä½œè¿›è¡Œï¼Œç”± JVM å®žçŽ°è‡ªè¡Œå†³å®šæ˜¯å¦ä¿è¯ 64-bit æ•°æ®ç±»åž‹çš„æ“ä½œåŽŸå­æ€§ã€‚åŸºæœ¬ä¸ŠéžåŽŸå­æ€§è®¿é—®è¡Œä¸ºçš„å®‰å…¨é—®é¢˜ä¸ä¼šå‘ç”Ÿã€‚

### 12.3.5 åŽŸå­æ€§ã€å¯è§æ€§ä¸Žæœ‰åºæ€§

JMM å¦‚ä½•åœ¨å¹¶å‘è¿‡ç¨‹ä¸­å¤„ç†åŽŸå­æ€§ã€å¯è§æ€§å’Œæœ‰åºæ€§ã€‚

#### 12.3.5.1 åŽŸå­æ€§ (Atomicity)

åŸºæœ¬æ•°æ®ç±»åž‹çš„è®¿é—®ã€è¯»å†™éƒ½æ˜¯åŽŸå­çš„ã€‚JVM æœªæŠŠ `lock` å’Œ `unlock` ç›´æŽ¥å¼€æ”¾ç»™ç”¨æˆ·ï¼Œä½†æä¾›äº†æ›´é«˜å±‚æ¬¡çš„å­—èŠ‚ç æŒ‡ä»¤ `monitorenter` å’Œ `monitorexit`ã€‚åæ˜ åˆ° Java ä»£ç ä¸­å°±æ˜¯ `synchronized` å…³é”®å­—ã€‚

#### 12.3.5.2 å¯è§æ€§ (Visibility)

å½“ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†å…±äº«å˜é‡çš„å€¼æ—¶ï¼Œå…¶å®ƒçº¿ç¨‹èƒ½å¤Ÿç«‹å³å¾—çŸ¥è¿™ä¸ªä¿®æ”¹ï¼š

* å˜é‡ä¿®æ”¹åŽç«‹å³åŒæ­¥å›žä¸»å†…å­˜
* å˜é‡è¯»å–å‰ä»Žä¸»å†…å­˜åˆ·æ–°

#### 12.3.5.3 æœ‰åºæ€§ (Ordering)

åœ¨æœ¬çº¿ç¨‹å†…è§‚å¯Ÿï¼Œæ‰€æœ‰æ“ä½œéƒ½æ˜¯æœ‰åºçš„ï¼›å¦‚æžœåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è§‚å¯Ÿå¦ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€æœ‰æ“ä½œéƒ½æ˜¯æ— åºçš„ã€‚

> ï¼Ÿ

---

